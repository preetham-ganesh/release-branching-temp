name: "[Reuse] Finalize Release"

on:
  workflow_dispatch:
    inputs:
      release_branch:
        description: "Release branch to finalize (example: release/v1.2.3)"
        required: true
        type: string
      base_branch:
        description: "Base branch to PR into (usually main)"
        required: false
        default: "main"
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  release_branch:
    name: Finalize Release
    runs-on: ubuntu-latest

    steps:
      - name: Validate Input Branch
        run: |
          echo "Release branch: ${{ inputs.release_branch }}"
          if [[ "${{ inputs.release_branch }}" != release/* ]]; then
            echo "This workflow should only be triggered for release/* branches."
            exit 1
          fi

      - name: Checkout Release Branch
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Poetry
        run: |
          pipx install poetry

      - name: Capture Release Version
        run: |
          echo "RELEASE_VERSION=$(poetry version -s | egrep -o '^[^r]+')" >> $GITHUB_ENV
          echo "RELEASE_BRANCH_NAME=${{ inputs.release_branch }}" >> $GITHUB_ENV
          echo "FINAL_RELEASE_BRANCH_NAME=final/${{ inputs.release_branch }}" >> $GITHUB_ENV
          echo "BASE_BRANCH=${{ inputs.base_branch }}" >> $GITHUB_ENV

      - name: Checkout Base Branch & Capture Base Version
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.base_branch }}
          fetch-depth: 0

      - name: Capture Base Version
        run: |
          echo "BASE_RELEASE_VERSION=$(poetry version -s | egrep -o '^[^r]+')" >> $GITHUB_ENV

      - name: Fail If final/* Branch Already Exists
        run: |
          git fetch --all --prune
          if git ls-remote --exit-code --heads origin "$FINAL_RELEASE_BRANCH_NAME" >/dev/null; then
            echo "Branch already exists: $FINAL_RELEASE_BRANCH_NAME"
            exit 1
          fi

      - name: Fail If Version Is Not Ahead Of Base
        run: |
          pip install semver
          python -c "
          import semver
          if semver.compare('${{ env.RELEASE_VERSION }}', '${{ env.BASE_RELEASE_VERSION }}') <= 0:
              raise ValueError('Release version must be > base version')
          "

      - name: Checkout Release Branch Again
        uses: actions/checkout@v3
        with:
          ref: ${{ inputs.release_branch }}
          fetch-depth: 0

      - name: Create final/* Branch (commit FINAL marker)
        run: |
          git checkout -b "$FINAL_RELEASE_BRANCH_NAME"
          poetry version "$RELEASE_VERSION"
          git status
          git commit -am "ci(pyproject.toml): $RELEASE_VERSION FINAL" || echo "No changes to commit"
          git push -u origin "$FINAL_RELEASE_BRANCH_NAME"

      - name: Open PR to Base Branch
        run: |
          gh pr create \
            -B "$BASE_BRANCH" \
            -H "$FINAL_RELEASE_BRANCH_NAME" \
            --title "Promote $RELEASE_BRANCH_NAME" \
            --body "Created by GitHub Action"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Remove release/* Branch
        run: |
          git push origin --delete "$RELEASE_BRANCH_NAME"
